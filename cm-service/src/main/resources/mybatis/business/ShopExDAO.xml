<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 在这里存放用户自定义的映射配置（注：ShopDAO.xml里各节点的ID不能在这里重复出现）  -->
<mapper namespace="cn.eatammy.cm.dao.business.IShopDAO">

    <select id="queryPageEx" resultType="cn.eatammy.cm.domain.business.ShopEx">
		SELECT cbs.id as id, cbs.shopName as shopName,cbs.`code` as code, cbs.address as address,
		cbs.createDate as createDate, cbs.`status` as `status`,
		csc.`name` AS categoryName,cbs.owner AS owner
	    FROM cm_business_shop cbs LEFT JOIN cm_user_detail cud on cbs.uid = cud.`code`
	    LEFT JOIN cm_sys_category csc ON cbs.categoryId = csc.id
        <where>
            csc.status = 0 AND cud.status = 0
            <if test="condition.shopName != null and condition.shopName != ''">
              AND cbs.shopName = #{condition.shopName}
            </if>
            <if test="condition.username != null and condition.username != ''">
              AND cud.username = #{condition.username}
            </if>
            <if test="condition.categoryId != null and condition.categoryId != -1">
              AND cbs.categoryId = #{condition.categoryId}
            </if>
            <if test="condition.province != null and condition.province != -1">
              AND cbs.province = #{condition.province}
            </if>
            <if test="condition.city != null and condition.city != -1">
              AND cbs.city = #{condition.city}
            </if>
            <if test="condition.town != null and condition.town != -1">
              AND cbs.town = #{condition.town}
            </if>
            <if test="condition.status != null and condition.status != -1">
              and cbs.status = condition.status
            </if>
        </where>
        group by cbs.id
        order by cbs.id desc
        <if test="offset != null">
            limit ${offset}, ${rows}
        </if>
	</select>

    <select id="countEx" resultType="java.lang.Integer">
        SELECT count(1)
        FROM cm_business_shop cbs LEFT JOIN cm_user_detail cud on cbs.uid = cud.`code`
        LEFT JOIN cm_sys_category csc ON cbs.categoryId = csc.id
        <where>
            csc.status = 0 AND cud.status = 0
            <if test="condition.shopName != null and condition.shopName != ''">
                AND cbs.shopName = #{condition.shopName}
            </if>
            <if test="condition.username != null and condition.username != ''">
                AND cud.username = #{condition.username}
            </if>
            <if test="condition.categoryId != null and condition.categoryId != -1">
                AND cbs.categoryId = #{condition.categoryId}
            </if>
            <if test="condition.province != null and condition.province != -1">
                AND cbs.province = #{condition.province}
            </if>
            <if test="condition.city != null and condition.city != -1">
                AND cbs.city = #{condition.city}
            </if>
            <if test="condition.town != null and condition.town != -1">
                AND cbs.town = #{condition.town}
            </if>
            <if test="condition.status != null and condition.status != -1">
                and cbs.status = condition.status
            </if>
        </where>
    </select>

    <select id="queryOneEx" resultType="cn.eatammy.cm.domain.business.ShopEx">
        SELECT cbs.*,csc.`name` AS categoryName,cud.username as username, cud.nickname as nickname
	    FROM cm_business_shop cbs LEFT JOIN cm_user_detail cud on cbs.uid = cud.`code`
	    LEFT JOIN cm_sys_category csc ON cbs.categoryId = csc.id
        WHERE cbs.code = #{code}
    </select>
    <select id="queryShopByUid" resultType="cn.eatammy.cm.domain.business.ShopEx">
        SELECT cbs.*,csc.`name` AS categoryName,cud.username as username, cud.nickname as nickname
	    FROM cm_business_shop cbs LEFT JOIN cm_user_detail cud on cbs.uid = cud.`code`
	    LEFT JOIN cm_sys_category csc ON cbs.categoryId = csc.id
        WHERE cbs.uid = #{uid} and cbs.status = 0;
    </select>

    <update id="updateShopStatus">
        UPDATE  cm_business_shop
        set status = #{status}
        where id = #{id}
    </update>

</mapper>